<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.aviation.metadata.service.impl.MetaDataSearchMapper">

    <select id="getMetaDataSearchList" parameterType="egovframework.aviation.metadata.vo.MetaDataSearchVO" resultType="egovframework.aviation.metadata.vo.MetaDataSearchVO">
           SELECT R1.* FROM( 
	             select 
					 row_number() over(order by nib.REG_DATE desc) as rnum	
					,nib.ITEM_IDX 
					,lag(ITEM_IDX, 1) over (order by REG_DATE DESC) as PREV
					,lead(ITEM_IDX, 1) over (order by REG_DATE DESC) as NEXT
					,(SELECT ni.IMAGE_IDX from nam_image ni WHERE ni.ITEM_IDX = nib.ITEM_IDX AND REP_IMAGE = 'Y') as IMAGE_IDX 
					,(SELECT ni.IMAGE_PATH from nam_image ni WHERE ni.ITEM_IDX = nib.ITEM_IDX AND REP_IMAGE = 'Y') as IMAGE_PATH 
					,nib.ORG_CODE_IDX 
					,nib.POSSESSION_CODE_IDX
					,(SELECT npc.POSSESSION_NM from nam_possession_code npc WHERE npc.POSSESSION_CODE_IDX = nib.POSSESSION_CODE_IDX) as POSSESSION_NM 
					,nib.ITEM_NO 
					,nib.ITEM_DETAIL_NO 
					,nib.ITEM_NM 
					,nib.ITEM_SE_NM 
					,nib.ITEM_ENG_NM 
					,nib.AUTHOR 
					,nib.QTY 
					,nib.QTY_UNIT_CODE_IDX 
					,nib.ICAO_CODE_IDX 
					,(SELECT nic.ICAO_NM FROM nam_icao_code nic WHERE nic.ICAO_CODE_IDX = nib.ICAO_CODE_IDX) as ICAO_NM
					,nib.EXISTENCE_CODE_IDX 
					,nib.MANAGEMENT_NO 
					,nib.PRESERVATION_NEED 
					,nib.FEATURE 
					,nib.CONDITION_CODE_IDX 
					,nib.RANKING_CODE_IDX 
					,nib.REMARK 
					,nib.REG_STATE 
					,nib.REG_USER 
					,nib.REG_DATE 
					,nib.MOD_USER 
					,nib.MOD_DATE 
					,(SELECT ncc.COUNTRY_NM from nam_country_code ncc WHERE ncc.COUNTRY_CODE_IDX =(SELECT nce.COUNTRY_CODE_IDX from nam_country_era nce WHERE ITEM_IDX = #{item_idx} limit 1)) as COUNTRY_NM
					,(SELECT nsc.STORAGE_NM FROM nam_movement nm join nam_storage ns on nm.MOVEMENT_IDX = ns.MOVEMENT_IDX join nam_storage_code nsc on ns.STORAGE_CODE_IDX = nsc.STORAGE_CODE_IDX WHERE nm.ITEM_IDX = #{item_idx} ORDER by nm.MOVEMENT_DATE DESC , nm.REG_DATE DESC limit 1) as STORAGE_NM
					,(SELECT nm2.MEASUREMENT_VALUE FROM nam_measurement nm2 WHERE nm2.ITEM_IDX = #{item_idx} limit 1) as MEASUREMENT_VALUE
					,(SELECT ncc.CLASS1_NM from nam_taxonomy nt join nam_class1_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS1_CODE_IDX WHERE nt.item_idx = #{item_idx} limit 1) as CLASS1_NM
					,(SELECT ncc.CLASS2_NM from nam_taxonomy nt join nam_class2_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS2_CODE_IDX WHERE nt.item_idx = #{item_idx} limit 1) as CLASS2_NM
					,(SELECT ncc.CLASS3_NM from nam_taxonomy nt join nam_class3_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS3_CODE_IDX WHERE nt.item_idx = #{item_idx} limit 1) as CLASS3_NM
				from nam_item_base nib
				WHERE 1=1
				<if test=" '' != search_word and null != search_word">
					AND (nib.ITEM_NO LIKE CONCAT('%', #{search_word}, '%') OR nib.ITEM_DETAIL_NO LIKE CONCAT('%', #{search_word}, '%') OR nib.ITEM_NM LIKE CONCAT('%', #{search_word}, '%')) 
				</if>
            ) R1
           	<if test=" '' != item_idx and null != item_idx">
				WHERE ITEM_IDX = #{item_idx}
			</if>
            LIMIT #{perPageNum} OFFSET #{pageStart}  
	</select>
	
	<select id="getMetaDataSearchListCnt" resultType="Integer">
           SELECT 
          		 count(*)  
           FROM( 
	             select 
					 row_number() over(order by nib.REG_DATE desc) as rnum	
					,nib.ITEM_IDX 
					,lag(ITEM_IDX, 1) over (order by REG_DATE DESC) as PREV
					,lead(ITEM_IDX, 1) over (order by REG_DATE DESC) as NEXT
					,(SELECT ni.IMAGE_IDX from nam_image ni WHERE ni.ITEM_IDX = nib.ITEM_IDX AND REP_IMAGE = 'Y') as IMAGE_IDX 
					,(SELECT ni.IMAGE_PATH from nam_image ni WHERE ni.ITEM_IDX = nib.ITEM_IDX AND REP_IMAGE = 'Y') as IMAGE_PATH 
					,nib.ORG_CODE_IDX 
					,nib.POSSESSION_CODE_IDX
					,(SELECT npc.POSSESSION_NM from nam_possession_code npc WHERE npc.POSSESSION_CODE_IDX = nib.POSSESSION_CODE_IDX) as POSSESSION_NM 
					,nib.ITEM_NO 
					,nib.ITEM_DETAIL_NO 
					,nib.ITEM_NM 
					,nib.ITEM_SE_NM 
					,nib.ITEM_ENG_NM 
					,nib.AUTHOR 
					,nib.QTY 
					,nib.QTY_UNIT_CODE_IDX 
					,nib.ICAO_CODE_IDX 
					,(SELECT nic.ICAO_NM FROM nam_icao_code nic WHERE nic.ICAO_CODE_IDX = nib.ICAO_CODE_IDX) as ICAO_NM
					,nib.EXISTENCE_CODE_IDX 
					,nib.MANAGEMENT_NO 
					,nib.PRESERVATION_NEED 
					,nib.FEATURE 
					,nib.CONDITION_CODE_IDX 
					,nib.RANKING_CODE_IDX 
					,nib.REMARK 
					,nib.REG_STATE 
					,nib.REG_USER 
					,nib.REG_DATE 
					,nib.MOD_USER 
					,nib.MOD_DATE 
					<if test=" '' != item_idx and null != item_idx">
						,(SELECT ncc.COUNTRY_NM from nam_country_code ncc WHERE ncc.COUNTRY_CODE_IDX =(SELECT nce.COUNTRY_CODE_IDX from nam_country_era nce WHERE ITEM_IDX = #{item_idx} limit 1)) as COUNTRY_NM
						,(SELECT nsc.STORAGE_NM FROM nam_movement nm join nam_storage ns on nm.MOVEMENT_IDX = ns.MOVEMENT_IDX join nam_storage_code nsc on ns.STORAGE_CODE_IDX = nsc.STORAGE_CODE_IDX WHERE nm.ITEM_IDX = #{item_idx} ORDER by nm.MOVEMENT_DATE DESC , nm.REG_DATE DESC limit 1) as STORAGE_NM
						,(SELECT nm2.MEASUREMENT_VALUE FROM nam_measurement nm2 WHERE nm2.ITEM_IDX = #{item_idx} limit 1) as MEASUREMENT_VALUE
						,(SELECT ncc.CLASS1_NM from nam_taxonomy nt join nam_class1_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS1_CODE_IDX WHERE nt.item_idx = #{item_idx} limit 1) as CLASS1_NM
						,(SELECT ncc.CLASS2_NM from nam_taxonomy nt join nam_class2_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS2_CODE_IDX WHERE nt.item_idx = #{item_idx} limit 1) as CLASS2_NM
						,(SELECT ncc.CLASS3_NM from nam_taxonomy nt join nam_class3_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS3_CODE_IDX WHERE nt.item_idx = #{item_idx} limit 1) as CLASS3_NM
					</if>
				from nam_item_base nib
				WHERE 1=1
				<if test=" '' != search_word and null != search_word">
					AND (nib.ITEM_NO LIKE CONCAT('%', #{search_word}, '%') OR nib.ITEM_DETAIL_NO LIKE CONCAT('%', #{search_word}, '%') OR nib.ITEM_NM LIKE CONCAT('%', #{search_word}, '%')) 
				</if>
            ) R1
	</select>
	
    <select id="getMetaDataSearchImageList" parameterType="egovframework.aviation.metadata.vo.MetaDataSearchImageVO" resultType="egovframework.aviation.metadata.vo.MetaDataSearchImageVO">
           SELECT R1.* FROM( 
		           SELECT 
		   				 ni.*
						,row_number() over(order by REG_DATE DESC, IMAGE_IDX) as rnum
						,lag(IMAGE_IDX, 1) over (order by REG_DATE DESC, IMAGE_IDX) as PREV
						,lead(IMAGE_IDX, 1) over (order by REG_DATE DESC, IMAGE_IDX) as NEXT
						,nib.ITEM_NO 
						,nib.ITEM_DETAIL_NO 
						,nib.ITEM_NM 
						,nib.ITEM_SE_NM 
						,nib.ITEM_ENG_NM 
						,nib.AUTHOR 
						,nib.QTY 
						,nib.QTY_UNIT_CODE_IDX 
						,nib.ICAO_CODE_IDX 
						,(SELECT nic.ICAO_NM FROM nam_icao_code nic WHERE nic.ICAO_CODE_IDX = nib.ICAO_CODE_IDX) as ICAO_NM
						,(SELECT nit.TAG_NM from nam_image_tag nit WHERE nit.IMAGE_IDX = ni.IMAGE_IDX) as TAG_NM
						,(SELECT npc.POSSESSION_NM from nam_possession_code npc WHERE npc.POSSESSION_CODE_IDX = nib.POSSESSION_CODE_IDX) as POSSESSION_NM 
						,(SELECT ncc.COUNTRY_NM from nam_country_code ncc WHERE ncc.COUNTRY_CODE_IDX =(SELECT nce.COUNTRY_CODE_IDX from nam_country_era nce WHERE ITEM_IDX = ni.ITEM_IDX limit 1)) as COUNTRY_NM
						,(SELECT nsc.STORAGE_NM FROM nam_movement nm join nam_storage ns on nm.MOVEMENT_IDX = ns.MOVEMENT_IDX join nam_storage_code nsc on ns.STORAGE_CODE_IDX = nsc.STORAGE_CODE_IDX WHERE nm.ITEM_IDX = ni.ITEM_IDX ORDER by nm.MOVEMENT_DATE DESC , nm.REG_DATE DESC limit 1) as STORAGE_NM
						,(SELECT nm2.MEASUREMENT_VALUE FROM nam_measurement nm2 WHERE nm2.ITEM_IDX = ni.ITEM_IDX limit 1) as MEASUREMENT_VALUE
						,(SELECT ncc.CLASS1_NM from nam_taxonomy nt join nam_class1_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS1_CODE_IDX WHERE nt.item_idx = ni.ITEM_IDX limit 1) as CLASS1_NM
						,(SELECT ncc.CLASS2_NM from nam_taxonomy nt join nam_class2_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS2_CODE_IDX WHERE nt.item_idx = ni.ITEM_IDX limit 1) as CLASS2_NM
						,(SELECT ncc.CLASS3_NM from nam_taxonomy nt join nam_class3_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS3_CODE_IDX WHERE nt.item_idx = ni.ITEM_IDX limit 1) as CLASS3_NM
					FROM 
						nam_image ni
					join nam_item_base nib 
					on ni.ITEM_IDX = nib.ITEM_IDX 
					WHERE 1=1
					<if test=" '' != search_word and null != search_word">
						AND (nib.ITEM_NO LIKE CONCAT('%', #{search_word}, '%') OR nib.ITEM_DETAIL_NO LIKE CONCAT('%', #{search_word}, '%') OR nib.ITEM_NM LIKE CONCAT('%', #{search_word}, '%')) 
					</if>
            ) R1
            <if test=" '' != image_idx and null != image_idx">
				WHERE IMAGE_IDX = #{image_idx}
			</if>
            LIMIT #{perPageNum} OFFSET #{pageStart}  
	</select>
	
	<select id="getMetaDataSearchImageListCnt" resultType="Integer">
             SELECT
             	count(*) 
			 FROM( 
		           SELECT 
		   				 ni.*
						,row_number() over(order by REG_DATE DESC, IMAGE_IDX) as rnum
						,lag(IMAGE_IDX, 1) over (order by REG_DATE DESC, IMAGE_IDX) as PREV
						,lead(IMAGE_IDX, 1) over (order by REG_DATE DESC, IMAGE_IDX) as NEXT
						,nib.ITEM_NO 
						,nib.ITEM_DETAIL_NO 
						,nib.ITEM_NM 
						,nib.ITEM_SE_NM 
						,nib.ITEM_ENG_NM 
						,nib.AUTHOR 
						,nib.QTY 
						,nib.QTY_UNIT_CODE_IDX 
						,nib.ICAO_CODE_IDX 
						,(SELECT nic.ICAO_NM FROM nam_icao_code nic WHERE nic.ICAO_CODE_IDX = nib.ICAO_CODE_IDX) as ICAO_NM
						,(SELECT nit.TAG_NM from nam_image_tag nit WHERE nit.IMAGE_IDX = ni.IMAGE_IDX) as TAG_NM
						,(SELECT npc.POSSESSION_NM from nam_possession_code npc WHERE npc.POSSESSION_CODE_IDX = nib.POSSESSION_CODE_IDX) as POSSESSION_NM 
						,(SELECT ncc.COUNTRY_NM from nam_country_code ncc WHERE ncc.COUNTRY_CODE_IDX =(SELECT nce.COUNTRY_CODE_IDX from nam_country_era nce WHERE ITEM_IDX = ni.ITEM_IDX limit 1)) as COUNTRY_NM
						,(SELECT nsc.STORAGE_NM FROM nam_movement nm join nam_storage ns on nm.MOVEMENT_IDX = ns.MOVEMENT_IDX join nam_storage_code nsc on ns.STORAGE_CODE_IDX = nsc.STORAGE_CODE_IDX WHERE nm.ITEM_IDX = ni.ITEM_IDX ORDER by nm.MOVEMENT_DATE DESC , nm.REG_DATE DESC limit 1) as STORAGE_NM
						,(SELECT nm2.MEASUREMENT_VALUE FROM nam_measurement nm2 WHERE nm2.ITEM_IDX = ni.ITEM_IDX limit 1) as MEASUREMENT_VALUE
						,(SELECT ncc.CLASS1_NM from nam_taxonomy nt join nam_class1_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS1_CODE_IDX WHERE nt.item_idx = ni.ITEM_IDX limit 1) as CLASS1_NM
						,(SELECT ncc.CLASS2_NM from nam_taxonomy nt join nam_class2_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS2_CODE_IDX WHERE nt.item_idx = ni.ITEM_IDX limit 1) as CLASS2_NM
						,(SELECT ncc.CLASS3_NM from nam_taxonomy nt join nam_class3_code ncc on nt.CLASS1_CODE_IDX = ncc.CLASS3_CODE_IDX WHERE nt.item_idx = ni.ITEM_IDX limit 1) as CLASS3_NM
					FROM 
						nam_image ni
					join nam_item_base nib 
					on ni.ITEM_IDX = nib.ITEM_IDX 
					WHERE 1=1
					<if test=" '' != search_word and null != search_word">
						AND (nib.ITEM_NO LIKE CONCAT('%', #{search_word}, '%') OR nib.ITEM_DETAIL_NO LIKE CONCAT('%', #{search_word}, '%') OR nib.ITEM_NM LIKE CONCAT('%', #{search_word}, '%')) 
					</if>
            ) R1
	</select>
	
	<insert id="insertKeyword" parameterType="egovframework.aviation.mypage.vo.InterestVO">
		    INSERT INTO nam_interest
                  ( ITEM_IDX
                  , EXPL
                  , REG_USER
                  , REG_DATE )
           VALUES ( #{item_idx}
                  , #{expl}
                  , #{reg_user}
                  , now())
    </insert>
</mapper>